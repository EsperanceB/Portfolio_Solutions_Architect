  AWSTemplateFormatVersion: '2010-09-09'
  Description: 'Network Infrastructure Stack - VPC, Subnets, NAT Gateway, Security Groups for AWS Portfolio Website'

  Parameters:
    EnvironmentName:
      Description: An environment name that will be prefixed to resource names
      Type: String
      Default: AWSPortfolio

    VpcCIDR:
      Description: IP range (CIDR notation) for this VPC
      Type: String
      Default: 10.0.0.0/16

    PublicSubnet1CIDR:
      Description: IP range (CIDR notation) for the public subnet in AZ1
      Type: String
      Default: 10.0.1.0/24

    PublicSubnet2CIDR:
      Description: IP range (CIDR notation) for the public subnet in AZ2
      Type: String
      Default: 10.0.2.0/24

    PrivateSubnet1CIDR:
      Description: IP range (CIDR notation) for the private subnet in AZ1
      Type: String
      Default: 10.0.11.0/24

    PrivateSubnet2CIDR:
      Description: IP range (CIDR notation) for the private subnet in AZ2
      Type: String
      Default: 10.0.12.0/24

  Resources:
    # VPC
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: !Ref VpcCIDR
        EnableDnsHostnames: true
        EnableDnsSupport: true
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-VPC

    # Internet Gateway
    InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-IGW

    InternetGatewayAttachment:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        InternetGatewayId: !Ref InternetGateway
        VpcId: !Ref VPC

    # Public Subnets
    PublicSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !GetAZs '']
        CidrBlock: !Ref PublicSubnet1CIDR
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Public-Subnet-AZ1

    PublicSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !GetAZs '']
        CidrBlock: !Ref PublicSubnet2CIDR
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Public-Subnet-AZ2

    # Private Subnets
    PrivateSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !GetAZs '']
        CidrBlock: !Ref PrivateSubnet1CIDR
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Private-Subnet-AZ1

    PrivateSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !GetAZs '']
        CidrBlock: !Ref PrivateSubnet2CIDR
        MapPublicIpOnLaunch: false
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Private-Subnet-AZ2

    # NAT Instance 1 (Replaces NAT Gateway 1)
    NATInstance1EIP:
      Type: AWS::EC2::EIP
      DependsOn: InternetGatewayAttachment
      Properties:
        Domain: vpc
        InstanceId: !Ref NATInstance1
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-NAT-Instance-EIP-AZ1

    NATInstance1:
      Type: AWS::EC2::Instance
      DependsOn: InternetGatewayAttachment
      Properties:
        ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-kernel-5.10-hvm-x86_64-gp2}}'
        InstanceType: t3.nano
        SubnetId: !Ref PublicSubnet1
        SecurityGroupIds:
          - !Ref NATInstanceSecurityGroup
        SourceDestCheck: false
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            # Enable IP forwarding and NAT
            echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
            sysctl -p
            
            # Configure iptables for NAT
            yum install -y iptables-services
            systemctl enable iptables
            systemctl start iptables
            
            # Setup NAT rules
            iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
            iptables -F FORWARD
            service iptables save
            
            # Log NAT instance startup
            echo "NAT Instance started at $(date)" >> /var/log/nat-startup.log
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-NAT-Instance-AZ1

    # NAT Instance 2 (Replaces NAT Gateway 2)
    NATInstance2EIP:
      Type: AWS::EC2::EIP
      DependsOn: InternetGatewayAttachment
      Properties:
        Domain: vpc
        InstanceId: !Ref NATInstance2
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-NAT-Instance-EIP-AZ2

    NATInstance2:
      Type: AWS::EC2::Instance
      DependsOn: InternetGatewayAttachment
      Properties:
        ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-kernel-5.10-hvm-x86_64-gp2}}'
        InstanceType: t3.nano
        SubnetId: !Ref PublicSubnet2
        SecurityGroupIds:
          - !Ref NATInstanceSecurityGroup
        SourceDestCheck: false
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            # Enable IP forwarding and NAT
            echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
            sysctl -p
            
            # Configure iptables for NAT
            yum install -y iptables-services
            systemctl enable iptables
            systemctl start iptables
            
            # Setup NAT rules
            iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
            iptables -F FORWARD
            service iptables save
            
            # Log NAT instance startup
            echo "NAT Instance started at $(date)" >> /var/log/nat-startup.log
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-NAT-Instance-AZ2

    # Public Route Table
    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Public-Routes

    DefaultPublicRoute:
      Type: AWS::EC2::Route
      DependsOn: InternetGatewayAttachment
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

    PublicSubnet1RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet1

    PublicSubnet2RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PublicRouteTable
        SubnetId: !Ref PublicSubnet2

    # Private Route Table 1
    PrivateRouteTable1:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Private-Routes-AZ1

    DefaultPrivateRoute1:
      Type: AWS::EC2::Route
      Properties:
        RouteTableId: !Ref PrivateRouteTable1
        DestinationCidrBlock: 0.0.0.0/0
        InstanceId: !Ref NATInstance1

    PrivateSubnet1RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable1
        SubnetId: !Ref PrivateSubnet1

    # Private Route Table 2
    PrivateRouteTable2:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-Private-Routes-AZ2

    DefaultPrivateRoute2:
      Type: AWS::EC2::Route
      Properties:
        RouteTableId: !Ref PrivateRouteTable2
        DestinationCidrBlock: 0.0.0.0/0
        InstanceId: !Ref NATInstance2

    PrivateSubnet2RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        RouteTableId: !Ref PrivateRouteTable2
        SubnetId: !Ref PrivateSubnet2

    # Security Groups
    # NAT Instance Security Group
    NATInstanceSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupName: !Sub ${EnvironmentName}-NAT-Instance-SG
        GroupDescription: Security group for NAT instances
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIp: 10.0.0.0/16
            Description: Allow HTTP from VPC
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 10.0.0.0/16
            Description: Allow HTTPS from VPC
          - IpProtocol: icmp
            FromPort: -1
            ToPort: -1
            CidrIp: 10.0.0.0/16
            Description: Allow ICMP from VPC
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
            Description: Allow all outbound traffic
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-NAT-Instance-SG

    ALBSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupName: !Sub ${EnvironmentName}-ALB-SG
        GroupDescription: Security group for Application Load Balancer
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIp: 0.0.0.0/0
            Description: Allow HTTP from anywhere
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 0.0.0.0/0
            Description: Allow HTTPS from anywhere
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
            Description: Allow all outbound traffic
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-ALB-SG

    WebServerSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupName: !Sub ${EnvironmentName}-WebServer-SG
        GroupDescription: Security group for web servers (EC2 instances)
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            SourceSecurityGroupId: !Ref ALBSecurityGroup
            Description: Allow HTTP from ALB
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            SourceSecurityGroupId: !Ref ALBSecurityGroup
            Description: Allow HTTPS from ALB
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
            Description: Allow all outbound traffic
        Tags:
          - Key: Name
            Value: !Sub ${EnvironmentName}-WebServer-SG

  Outputs:
    VPC:
      Description: VPC ID
      Value: !Ref VPC
      Export:
        Name: !Sub ${EnvironmentName}-VPC-ID

    PublicSubnets:
      Description: List of public subnet IDs
      Value: !Join [',', [!Ref PublicSubnet1, !Ref PublicSubnet2]]
      Export:
        Name: !Sub ${EnvironmentName}-Public-Subnets

    PrivateSubnets:
      Description: List of private subnet IDs
      Value: !Join [',', [!Ref PrivateSubnet1, !Ref PrivateSubnet2]]
      Export:
        Name: !Sub ${EnvironmentName}-Private-Subnets

    PublicSubnet1:
      Description: Public Subnet 1 ID
      Value: !Ref PublicSubnet1
      Export:
        Name: !Sub ${EnvironmentName}-Public-Subnet-1

    PublicSubnet2:
      Description: Public Subnet 2 ID
      Value: !Ref PublicSubnet2
      Export:
        Name: !Sub ${EnvironmentName}-Public-Subnet-2

    PrivateSubnet1:
      Description: Private Subnet 1 ID
      Value: !Ref PrivateSubnet1
      Export:
        Name: !Sub ${EnvironmentName}-Private-Subnet-1

    PrivateSubnet2:
      Description: Private Subnet 2 ID
      Value: !Ref PrivateSubnet2
      Export:
        Name: !Sub ${EnvironmentName}-Private-Subnet-2

    ALBSecurityGroup:
      Description: Security group for Application Load Balancer
      Value: !Ref ALBSecurityGroup
      Export:
        Name: !Sub ${EnvironmentName}-ALB-SG-ID

    WebServerSecurityGroup:
      Description: Security group for web servers
      Value: !Ref WebServerSecurityGroup
      Export:
        Name: !Sub ${EnvironmentName}-WebServer-SG-ID

    NATInstance1Id:
      Description: NAT Instance 1 ID
      Value: !Ref NATInstance1
      Export:
        Name: !Sub ${EnvironmentName}-NAT-Instance-1-ID

    NATInstance2Id:
      Description: NAT Instance 2 ID
      Value: !Ref NATInstance2
      Export:
        Name: !Sub ${EnvironmentName}-NAT-Instance-2-ID

    NATInstance1EIP:
      Description: Elastic IP for NAT Instance 1
      Value: !Ref NATInstance1EIP
      Export:
        Name: !Sub ${EnvironmentName}-NAT-Instance-1-EIP

    NATInstance2EIP:
      Description: Elastic IP for NAT Instance 2
      Value: !Ref NATInstance2EIP
      Export:
        Name: !Sub ${EnvironmentName}-NAT-Instance-2-EIP
